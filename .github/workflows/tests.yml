name: ResiCentral Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: resicentral_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      minio:
        image: minio/minio
        env:
          MINIO_ACCESS_KEY: test_access_key
          MINIO_SECRET_KEY: test_secret_key
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live"
          --health-interval 30s
          --health-timeout 20s
          --health-retries 3
        ports:
          - 9000:9000

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up environment variables
      working-directory: ./backend
      run: |
        cp .env.example .env
        echo "DATABASE_URL=postgresql://test_user:test_password@localhost:5432/resicentral_test" >> .env
        echo "MINIO_ENDPOINT=localhost:9000" >> .env
        echo "MINIO_ACCESS_KEY=test_access_key" >> .env
        echo "MINIO_SECRET_KEY=test_secret_key" >> .env
        echo "JWT_SECRET_KEY=test_jwt_secret_key_for_ci" >> .env
        echo "ENVIRONMENT=testing" >> .env

    - name: Wait for services
      run: |
        sleep 30
        curl -f http://localhost:9000/minio/health/live || exit 1

    - name: Run linting
      working-directory: ./backend
      run: |
        pip install ruff black
        ruff check app/
        black --check app/

    - name: Run type checking
      working-directory: ./backend
      run: |
        pip install mypy
        mypy app/ --ignore-missing-imports

    - name: Run unit tests
      working-directory: ./backend
      run: |
        python -m pytest tests/test_models.py tests/test_crud.py -v --tb=short

    - name: Run integration tests
      working-directory: ./backend
      run: |
        python -m pytest tests/test_endpoints.py -v --tb=short

    - name: Run all tests with coverage
      working-directory: ./backend
      run: |
        python -m pytest --cov=app --cov-report=xml --cov-report=term-missing --cov-fail-under=80

    - name: Upload backend coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: backend-coverage

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'

    - name: Cache Flutter dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          frontend/.dart_tool
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-flutter-

    - name: Install dependencies
      working-directory: ./frontend
      run: flutter pub get

    - name: Verify Flutter installation
      working-directory: ./frontend
      run: flutter doctor -v

    - name: Analyze code
      working-directory: ./frontend
      run: flutter analyze

    - name: Run unit tests
      working-directory: ./frontend
      run: flutter test test/unit_tests/ --reporter expanded

    - name: Run widget tests
      working-directory: ./frontend
      run: flutter test test/widget_tests/ --reporter expanded

    - name: Run all tests with coverage
      working-directory: ./frontend
      run: flutter test --coverage --reporter expanded

    - name: Generate coverage report
      working-directory: ./frontend
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov
        genhtml coverage/lcov.info -o coverage/html

    - name: Upload frontend coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-coverage-report
        path: frontend/coverage/html/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: resicentral_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      minio:
        image: minio/minio
        env:
          MINIO_ACCESS_KEY: test_access_key
          MINIO_SECRET_KEY: test_secret_key
        ports:
          - 9000:9000

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'

    - name: Install backend dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install frontend dependencies
      working-directory: ./frontend
      run: flutter pub get

    - name: Set up backend environment
      working-directory: ./backend
      run: |
        cp .env.example .env
        echo "DATABASE_URL=postgresql://test_user:test_password@localhost:5432/resicentral_test" >> .env
        echo "MINIO_ENDPOINT=localhost:9000" >> .env
        echo "MINIO_ACCESS_KEY=test_access_key" >> .env
        echo "MINIO_SECRET_KEY=test_secret_key" >> .env
        echo "JWT_SECRET_KEY=test_jwt_secret_key_for_ci" >> .env
        echo "ENVIRONMENT=testing" >> .env

    - name: Start backend server
      working-directory: ./backend
      run: |
        python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        sleep 30

    - name: Health check backend
      run: |
        curl -f http://localhost:8000/health || exit 1

    - name: Build Flutter app for testing
      working-directory: ./frontend
      run: flutter build apk --debug

    - name: Run Flutter integration tests
      working-directory: ./frontend
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        script: flutter test integration_test/

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: [backend-tests]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run backend security scan
      working-directory: ./backend
      run: |
        pip install safety bandit
        safety check -r requirements.txt
        bandit -r app/ -f json -o security-report.json

    - name: Run frontend security scan
      working-directory: ./frontend
      run: |
        flutter pub deps --json > deps.json
        # Add security scanning for Flutter dependencies

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          backend/security-report.json
          frontend/deps.json

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, integration-tests, security-tests]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: |
          resicentral/backend:latest
          resicentral/backend:${{ github.sha }}

    - name: Setup Flutter for build
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'

    - name: Build Flutter web app
      working-directory: ./frontend
      run: |
        flutter pub get
        flutter build web --release

    - name: Deploy to staging
      if: github.ref == 'refs/heads/develop'
      run: |
        # Add staging deployment commands
        echo "Deploying to staging environment"

    - name: Deploy to production
      if: github.ref == 'refs/heads/main'
      run: |
        # Add production deployment commands
        echo "Deploying to production environment"

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, integration-tests, security-tests]
    if: always()

    steps:
    - name: Notify Slack on success
      if: ${{ needs.backend-tests.result == 'success' && needs.frontend-tests.result == 'success' }}
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#resicentral-ci'
        text: '✅ All tests passed! Ready for deployment.'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify Slack on failure
      if: ${{ needs.backend-tests.result == 'failure' || needs.frontend-tests.result == 'failure' }}
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#resicentral-ci'
        text: '❌ Tests failed! Please check the build logs.'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}